<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>03_slides_web-scraping.knit</title>
    <meta charset="utf-8" />
    <script src="03_slides_web-scraping_files/header-attrs-2.11/header-attrs.js"></script>
    <link href="03_slides_web-scraping_files/countdown-0.3.5/countdown.css" rel="stylesheet" />
    <script src="03_slides_web-scraping_files/countdown-0.3.5/countdown.js"></script>
    <link href="03_slides_web-scraping_files/tile-view-0.2.6/tile-view.css" rel="stylesheet" />
    <script src="03_slides_web-scraping_files/tile-view-0.2.6/tile-view.js"></script>
    <script src="03_slides_web-scraping_files/fabric-4.3.1/fabric.min.js"></script>
    <link href="03_slides_web-scraping_files/xaringanExtra-scribble-0.0.1/scribble.css" rel="stylesheet" />
    <script src="03_slides_web-scraping_files/xaringanExtra-scribble-0.0.1/scribble.js"></script>
    <script>document.addEventListener('DOMContentLoaded', function() { window.xeScribble = new Scribble({"pen_color":["#FF0000"],"pen_size":3,"eraser_size":30,"palette":[]}) })</script>
    <link href="03_slides_web-scraping_files/panelset-0.2.6/panelset.css" rel="stylesheet" />
    <script src="03_slides_web-scraping_files/panelset-0.2.6/panelset.js"></script>
    <script src="03_slides_web-scraping_files/clipboard-2.0.6/clipboard.min.js"></script>
    <link href="03_slides_web-scraping_files/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.css" rel="stylesheet" />
    <script src="03_slides_web-scraping_files/xaringanExtra-clipboard-0.2.6/xaringanExtra-clipboard.js"></script>
    <script>window.xaringanExtraClipboard(null, {"button":"Copy Code","success":"Copied!","error":"Press Ctrl+C to Copy"})</script>
    <link href="03_slides_web-scraping_files/xaringanExtra-extra-styles-0.2.6/xaringanExtra-extra-styles.css" rel="stylesheet" />
    <script src="03_slides_web-scraping_files/xaringanExtra-progressBar-0.0.1/progress-bar.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">

class: middle, center
background-image: url(img/capa3.png)
background-size: cover

---
class: middle, right
background-image: url(img/espera.gif)
background-position: left
background-size: contain

## Começamos em ...

.pull-right[
<div class="countdown" id="timer_622bbbfa" style="right:0;bottom:0;padding:50px;font-size:4em;" data-audio="true" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">05</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">30</span></code>
</div>
]



<style>.xe__progress-bar__container {
  top:0;
  opacity: 1;
  position:absolute;
  right:0;
  left: 0;
}
.xe__progress-bar {
  height: 0.25em;
  background-color: #0051BA;
  width: calc(var(--slide-current) / var(--slide-total) * 100%);
}
.remark-visible .xe__progress-bar {
  animation: xe__progress-bar__wipe 200ms forwards;
  animation-timing-function: cubic-bezier(.86,0,.07,1);
}
@keyframes xe__progress-bar__wipe {
  0% { width: calc(var(--slide-previous) / var(--slide-total) * 100%); }
  100% { width: calc(var(--slide-current) / var(--slide-total) * 100%); }
}</style>

---
class: middle, left
background-image: url(img/check-list.gif)
background-position: right
background-size: contain

## O que veremos hoje?

- Pacotes e funções para Web Scraping;
- Ética no Web Scraping
- Praticando o que aprendemos ...

---
## Panorama do Tabalho

&lt;img src="img/ideia-raspagem.png" width="2099" style="display: block; margin: auto;" /&gt;

---
class: inverse center middle

# Leitura

---
## Relembrando o rvest

.panelset[

.panel[.panel-name[`read_html()`]

- Faz a leitura do site!
- Estrutura: `rvest::read_html("url-do-site")`


```r
rvest::read_html("https://git.io/JMTRO")
```

```
## {html_document}
## &lt;html&gt;
## [1] &lt;head&gt;\n&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8 ...
## [2] &lt;body&gt;\n    &lt;h1&gt;Web Scraping com R&lt;/h1&gt;\n    &lt;h2&gt;Seção 01: Lista de links ...
```
.pull-left[
- Forma indireta:


```r
# prepara url -------------------------
url_teste &lt;- "https://git.io/JMTRO"

# salva a leitura do site -------------
site_teste &lt;- rvest::read_html(url_teste)
```

]

.pull-right[
- Se ocorrer erro de certificação


```r
site_teste &lt;- url |&gt; 
  httr::GET(httr::config(ssl_verifypeer = FALSE)) |&gt; 
  rvest::read_html()
```


]

]
.panel[.panel-name[`html_elements()`]

.pull-left[
- Seleciona os elementos HTML ou CSS associados.
- Use o SelectorGadget para auxiliar na escolha do CSS em questão
- A escolha adequada do elemento CSS pode reduzir o tempo de processamento e 
aliviar a memória de sua máquina!
- Sempre verifique se a extração ocorreu como desejada!



```r
site_teste |&gt; 
  rvest::html_elements("a")
```

```
## {xml_nodeset (3)}
## [1] &lt;a href="https://www.mathunion.org/"&gt; União Internaciional de Matemática  ...
## [2] &lt;a href="https://sbm.org.br/"&gt; Sociedade Brasileira de Matemática (SBM)&lt;/a&gt;
## [3] &lt;a href="https://www.sbmac.org.br/"&gt; Sociedade Brasileira de Matemática A ...
```
]

.pull-right[
nome          | descrição
-----------   | ----------
`h1` ... `h6` | seções
`p`           | parágrafo
`a`           | hyperlinks
`table`       | tabela
`ol`; `ul`    | listas
`li`          | item de lista
`b`           | negrito
`i`           | itálico

]

]
.panel[.panel-name[`html_attr()`]

- Seleciona o atributo associado a alguma _tag_
- Em nosso caso, um atributo associado à _tag_ `a` é a **referência do hyperlink**,
chamada `href`
  + ela possui um "nome" e um "valor"
  + desejamos extrair o "valor", geralmente


```r
site_teste |&gt; 
  rvest::html_elements("a") |&gt; 
  rvest::html_attr("href")
```


```r
https://www.mathunion.org/
https://sbm.org.br/
https://www.sbmac.org.br/
```

]
.panel[.panel-name[`html_text2()`]
- Seleciona o texto associado à _tag_, eliminando os espaços em branco, sempre que
possível.


```r
site_teste |&gt; 
  rvest::html_elements("a") |&gt; 
  rvest::html_text2()
```


```r
[1] "União Internaciional de Matemática (IMU)"                           
[2] "Sociedade Brasileira de Matemática (SBM)"                           
[3] "Sociedade Brasileira de Matemática Aplicada e Computacional (SBMAC)"
```


]
.panel[.panel-name[`html_table()`]
- Extrai uma tabela específica, se indicado o CSS;
- Extrai TODAS as tabelas, armazenando-as numa lista; se não indicado o CSS
- Se houver cabeçalho, usamos o argumento: `header = TRUE`


```r
site_teste |&gt; 
  rvest::html_table(header = TRUE)
```

```
## [[1]]
## # A tibble: 3 × 4
##   nome      preco_antigo preco_novo decisao
##   &lt;chr&gt;     &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;  
## 1 Álgebra   R$ 45,99     R$ 32,10   compre 
## 2 Geometria R$ 30,50     R$ 25,50   aguarde
## 3 Análise   R$ 80,00     R$ 72,00   aguarde
```

]
]

---
class: inverse center middle

# Arrumação

---
## Conhecendo o stringr

.panelset[

.panel[.panel-name[`str_sub()`]

.pull-left[
- Delimita a posição da extração nos caracteres
- Estruturação: `str_sub(start = a, end = b)`
- Uma desvantagem explícita é que precisamos contar as posições na string
  + dependendo do comprimento da string, isso pode ser um problema.

### Exemplo


```r
precos_teste &lt;- c(
  "R$ 45,99", "R$ 32,10",
  "R$ 25,50", "R$ 80,00"
)
```
]
.pull-right[


```r
stringr::str_sub(precos_teste, 4)
```

```
## [1] "45,99" "32,10" "25,50" "80,00"
```

```r
stringr::str_sub(precos_teste, -5)
```

```
## [1] "45,99" "32,10" "25,50" "80,00"
```

```r
stringr::str_sub(precos_teste, 4, 5)
```

```
## [1] "45" "32" "25" "80"
```

```r
stringr::str_sub(precos_teste, end = -4)
```

```
## [1] "R$ 45" "R$ 32" "R$ 25" "R$ 80"
```


]

]

.panel[.panel-name[`str_subset()`]

- Seleciona um subconjunto de caracteres, de acordo com algum padrão.
- Estrutura: `str_subset(variavel, "padrao")`
- Ter cuidado com "elementos especiais"
- Importante aprofundamento com REGEX.


```r
links_exemplos &lt;- c(
  "https://www.obm.org.br/content/uploads/2017/01/eureka34.doc",
  "https://www.obm.org.br/content/uploads/2017/01/eureka34.pdf",
  "https://www.obm.org.br/content/uploads/2017/01/Eureka33.doc",
  "https://www.obm.org.br/content/uploads/2017/01/Eureka33.pdf",
  "https://www.obm.org.br/content/uploads/2017/01/eureka32.doc"
)

stringr::str_subset(links_exemplos, ".pdf")
```

```
## [1] "https://www.obm.org.br/content/uploads/2017/01/eureka34.pdf"
## [2] "https://www.obm.org.br/content/uploads/2017/01/Eureka33.pdf"
```
]

.panel[.panel-name[`str_to_lower`]

- Coloca todas as letras em **minúsculas**
- Isso pode ser interessante na organização dos nomes dos arquivos.

### Exemplo


```r
frase_teste &lt;-  c("LIVRO - Introdução ao Cálculo")

stringr::str_to_lower(frase_teste)
```

```
## [1] "livro - introdução ao cálculo"
```

]

.panel[.panel-name[`str_replace_all`]
- Substitui um padrão anterior, por um novo.
- Estrutura: `str_replace_all("antigo", "novo")`

#### Exemplos

.pull-left[


```r
# substituindo pontuação --------------
precos_teste
```

```
## [1] "R$ 45,99" "R$ 32,10" "R$ 25,50" "R$ 80,00"
```

```r
precos_teste |&gt; 
  stringr::str_sub(4) |&gt; 
  stringr::str_replace_all(",", ".")
```

```
## [1] "45.99" "32.10" "25.50" "80.00"
```

]

.pull-right[


```r
# organizando nomes de arquivos -------
frase_teste
```

```
## [1] "LIVRO - Introdução ao Cálculo"
```

```r
frase_teste |&gt; 
  stringr::str_to_lower() |&gt; 
  stringr::str_replace_all(" - ", "_") |&gt; 
  stringr::str_replace_all(" ", "-")
```

```
## [1] "livro_introdução-ao-cálculo"
```
]
]

.panel[.panel-name[`str_trim()`]
- Elimina espaços em branco ou quebra de linhas
- Caracteres em HTML para essas situações: "`\n`", ou "`\r`"


```r
livros_exemplo &lt;- c(
  "Cálculo em uma Variável Complexa \n", 
  "introdução à álgrebra \r", 
  "Álgebra Linear \r"
)

livros_exemplo
```

```
## [1] "Cálculo em uma Variável Complexa \n" "introdução à álgrebra \r"           
## [3] "Álgebra Linear \r"
```

```r
stringr::str_trim(livros_exemplo)
```

```
## [1] "Cálculo em uma Variável Complexa" "introdução à álgrebra"           
## [3] "Álgebra Linear"
```
]

.panel[.panel-name[`str_c()`]

- Concatena uma sequência de caracteres; com possibilidade de escolher posição.

.pull-left[

```r
nome_pessoa &lt;- "Astrobaldo"
sobrenome_pessoa &lt;- "Beltrano"

stringr::str_c(nome_pessoa, sobrenome_pessoa)
```

```
## [1] "AstrobaldoBeltrano"
```

```r
stringr::str_c(nome_pessoa, " ", sobrenome_pessoa)
```

```
## [1] "Astrobaldo Beltrano"
```

```r
stringr::str_c(nome_pessoa, " - Belo nome!")
```

```
## [1] "Astrobaldo - Belo nome!"
```
]
.pull-right[

```r
seq(1, 9)
```

```
## [1] 1 2 3 4 5 6 7 8 9
```

```r
index &lt;- stringr::str_c("0", seq(1, 9))
index
```

```
## [1] "01" "02" "03" "04" "05" "06" "07" "08" "09"
```

```r
stringr::str_c(index, "_eureka.pdf")
```

```
## [1] "01_eureka.pdf" "02_eureka.pdf" "03_eureka.pdf" "04_eureka.pdf"
## [5] "05_eureka.pdf" "06_eureka.pdf" "07_eureka.pdf" "08_eureka.pdf"
## [9] "09_eureka.pdf"
```
]
]

]

---
## Pacotes com funções importantes na Arrumação

.panelset[

.panel[.panel-name[`stringi`]

- Vamos usar a função `stri_trans_general("Latin-ASCII")` para retirar toda 
acentuação do fragmento de texto.


```r
frase_acento &lt;- "Não há acentuação"

stringi::stri_trans_general(frase_acento, "Latin-ASCII")
```

```
## [1] "Nao ha acentuacao"
```


]
.panel[.panel-name[`readr`]

- A função `parse_double()` transforma os números da classe `character` para `numeric`.
  + Atenção! Não é possível realizar cálculos com caracteres

.pull-left[


```r
precos_teste
```

```
## [1] "R$ 45,99" "R$ 32,10" "R$ 25,50" "R$ 80,00"
```

```r
preco_caractere &lt;- precos_teste |&gt; 
  stringr::str_sub(4) |&gt; 
  stringr::str_replace_all(",", ".")

preco_caractere; class(preco_caractere)
```

```
## [1] "45.99" "32.10" "25.50" "80.00"
```

```
## [1] "character"
```
]

.pull-right[


```r
preco_numerico &lt;- preco_caractere |&gt; 
  readr::parse_double()

preco_numerico
```

```
## [1] 45.99 32.10 25.50 80.00
```

```r
class(preco_numerico)
```

```
## [1] "numeric"
```

]

]
.panel[.panel-name[`lubridate`]

- Para transformação e cálculos com datas

.pull-left[


```r
data_caractere &lt;- c("11/03/2022")

class(data_caractere)
```

```
## [1] "character"
```

```r
data_data &lt;- lubridate::dmy(data_caractere)

data_data
```

```
## [1] "2022-03-11"
```

```r
class(data_data)
```

```
## [1] "Date"
```
]
 
 .pull-right[
 
 #### Outra possibilidade
 

```r
# usando readr

readr::parse_date(data_caractere, "%d/%m/%Y")
```

```
## [1] "2022-03-11"
```

]

]
.panel[.panel-name[`dplyr`]
- Pata manipulação de tibbles.
- Usaremos para condicional em tibbles
- `if_else(condicao-desejada, "saida_caso-verdade", "saida_caso-contrário")`


```r
tabela_teste &lt;- tibble::tibble(
  numero = c(1, 2, 3, 4),
  calculo = c(1, 4, 6, 9),
  teste = dplyr::if_else(calculo == 2 * numero, "certo", "errado")
)

tabela_teste
```

```
## # A tibble: 4 × 3
##   numero calculo teste 
##    &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt; 
## 1      1       1 errado
## 2      2       4 certo 
## 3      3       6 certo 
## 4      4       9 errado
```


]
.panel[.panel-name[`purrr`]

.pull-left[

- Usada para iteração nos processos
- Estrutura: `purrr::funcao_purrr(args, funcao)`
- Usaremos a função `map_df()`
  + retorna uma tibble


```r
tabela_dobro &lt;- function(x){
  tibble::tibble(
    numero = x,
    dobro  = 2 * x
  )
}

tabela_dobro(3)
```

```
## # A tibble: 1 × 2
##   numero dobro
##    &lt;dbl&gt; &lt;dbl&gt;
## 1      3     6
```
]

.pull-right[

#### Iterando com purrr


```r
purrr::map_df(1:7, tabela_dobro)
```

```
## # A tibble: 7 × 2
##   numero dobro
##    &lt;int&gt; &lt;dbl&gt;
## 1      1     2
## 2      2     4
## 3      3     6
## 4      4     8
## 5      5    10
## 6      6    12
## 7      7    14
```

]

]

]

---
class: inverse center middle

# Armazenagem

.pull-left[
- Podemos armazenar na memória RAM do computador ou em algum arquivo de extesão
conveniente.
  + se for armazenar em computador, usamos `tibbles`
  + se for em arquivos separados, uma extensão comumente usada é `.csv`; e, para
  esses casos, usamos a função `write_csv()` do pacote `readr`.
- Estruturação da função: `write_csv(variavel-formada, "caminho/nome-com-extensao.csv")`
]
.pull-right[


```r
tabelao &lt;- purrr::map_df(1:1000, tabela_dobro)

write(tabelao, "documentos/tabelao.csv")
```

- O arquivo `tabelao.csv` foi salvo na pasta `documentos`; ambos dentro de seu
diretório de trabalho (pasta onde você está salvando os arquivos)

]

---
class: inverse center middle

# Ética no Web Scraping

---
## Sejamos Éticos!

.panelset[

.panel[.panel-name[`fluxo`]

&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="img/fluxo-requi.png" alt="https://www.bastter.com" width="80%" /&gt;
&lt;p class="caption"&gt;https://www.bastter.com&lt;/p&gt;
&lt;/div&gt;
]

.panel[.panel-name[`robots.txt`]

.pull-left[
- Uma forma de saber se o site permite a Raspagem de dados é acessar os **robots.txt**
  + [https://www.obm.org.br/robots.txt](https://www.obm.org.br/robots.txt)
- Sempre devemos ler o site para obtermos as informações devidas!
]
.pull-right[

&lt;img src="img/etica.jpg" width="70%" style="display: block; margin: auto;" /&gt;

]
]

]

---
class: inverse center middle

# Parte Prática!

---
class: middle, right
background-image: url(img/fall2.gif)
background-position: left
background-size: contain

--
## Vai dar ...

--
## tudo certo!


---
## Situações que faremos ...

--

- Raspar tabela
  + [https://pt.wikipedia.org/wiki/R_(linguagem_de_programa%C3%A7%C3%A3o)](https://pt.wikipedia.org/wiki/R_(linguagem_de_programa%C3%A7%C3%A3o))
--

- Fazer o _download_ simultâneo de vários pdfs
  + [https://www.obm.org.br/revista-eureka/](https://www.obm.org.br/revista-eureka/)
--

- Tabela de decisão
  + [https://www.edusp.com.br/loja/assuntos/21/matematica](https://www.edusp.com.br/loja/assuntos/21/matematica)
--

- Raspagem em mais de uma página
  + [https://www.mises.org.br/Articles_Thumbs.aspx](https://www.mises.org.br/Articles_Thumbs.aspx)

&lt;!-- final para agradecimentos------------------------------------------------&gt;

---
class: center, middle

# Obrigado!

&lt;/br&gt;
Slides criados com &lt;/br&gt; [`xaringan`](https://github.com/yihui/xaringan) e [`xaringanthemer`](https://github.com/gadenbuie/xaringanthemer).

&lt;/br&gt;
&lt;/br&gt;
&lt;/br&gt;
&lt;img src="img/rodape.png" width=600&gt;
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="libs/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"slideNumberFormat": "%current%",
"highlightStyle": "github",
"highlightLines": true,
"ratio": "16:9",
"countIncrementalSlides": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
